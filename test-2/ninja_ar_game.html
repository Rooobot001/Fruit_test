<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AR Fruit Ninja</title>
  <!-- A-Frame + MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
    }
    
    #hud {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      backdrop-filter: blur(5px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    #gameStatus {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      font-size: 24px;
      text-align: center;
      display: none;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .game-button {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
    }
    
    .game-button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <!-- å¾—åˆ†UI -->
  <div id="hud">
    Score: <span id="score">0</span><br>
    Missed: <span id="missed">0</span>
  </div>
  
  <!-- éŠæˆ²ç‹€æ…‹æç¤º -->
  <div id="gameStatus">
    <div id="statusText">è«‹æƒææ¨™è¨˜é–‹å§‹éŠæˆ²</div>
    <button class="game-button" id="restartBtn" onclick="restartGame()" style="display: none;">é‡æ–°é–‹å§‹</button>
  </div>

  <!-- A-Frameå ´æ™¯ -->
  <a-scene
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: true; uiLoading: #my-loading; uiScanning: #my-scanning; uiError: #my-error; maxTrack: 1; warmupTolerance: 5; missTolerance: 5;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    background="color: #000000"
  >
    <!-- è³‡æºé è¼‰ -->
    <a-assets>
      <!-- æ°´æœæ··åˆå™¨ -->
      <a-mixin id="apple-mixin" 
               geometry="primitive: sphere; radius: 0.1" 
               material="color: #FF6B6B; roughness: 0.2; metalness: 0.1; emissive: #330000">
      </a-mixin>
      <a-mixin id="banana-mixin" 
               geometry="primitive: cylinder; radius: 0.05; height: 0.15" 
               material="color: #FFE66D; roughness: 0.2; metalness: 0.1; emissive: #332200">
      </a-mixin>
      <a-mixin id="grape-mixin" 
               geometry="primitive: sphere; radius: 0.08" 
               material="color: #A8E6CF; roughness: 0.2; metalness: 0.1; emissive: #003300">
      </a-mixin>
      <a-mixin id="orange-mixin" 
               geometry="primitive: sphere; radius: 0.09" 
               material="color: #FF8E53; roughness: 0.3; metalness: 0.1; emissive: #331100">
      </a-mixin>
      <a-mixin id="plum-mixin" 
               geometry="primitive: sphere; radius: 0.07" 
               material="color: #C7CEEA; roughness: 0.2; metalness: 0.1; emissive: #110033">
      </a-mixin>
    </a-assets>

    <!-- ç›¸æ©Ÿè¨­å®š -->
    <a-camera position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse"></a-camera>

    <!-- ARæ¨™è¨˜ç›®æ¨™ -->
    <a-entity mindar-image-target="targetIndex: 0" id="gameMarker">
      <!-- éŠæˆ²å ´åœ°æŒ‡ç¤ºå™¨ -->
      <a-plane 
        position="0 0 0" 
        rotation="-90 0 0" 
        width="2" 
        height="2" 
        color="#4CC3D9" 
        opacity="0.3"
        material="transparent: true">
      </a-plane>
      
      <!-- æ°´æœå®¹å™¨ -->
      <a-entity id="fruitContainer"></a-entity>
      
      <!-- éŠæˆ²é‚Šç•Œæç¤º -->
      <a-text 
        value="AR Fruit Ninja" 
        position="0 0.5 0" 
        align="center" 
        color="#FF0000"
        scale="0.5 0.5 0.5">
      </a-text>
    </a-entity>
  </a-scene>

  <div id="my-loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; z-index: 1001;">
    <div style="margin-bottom: 20px;">ğŸ® æ­£åœ¨è¼‰å…¥ARç›¸æ©Ÿ...</div>
    <div style="font-size: 14px; color: #ccc;">è«‹ç¢ºä¿å…è¨±ç›¸æ©Ÿæ¬Šé™</div>
  </div>
  
  <div id="my-scanning" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; z-index: 1001;">
    <div style="margin-bottom: 20px;">ğŸ“± è«‹å°‡ç›¸æ©Ÿå°æº–ä»»ä½•ç‰©é«”é–‹å§‹æƒæ</div>
    <div style="font-size: 14px; color: #ccc; text-align: center;">å¯ä»¥ç”¨æ›¸æœ¬ã€é›œèªŒã€åç‰‡æˆ–ä»»ä½•æœ‰åœ–æ¡ˆçš„å¹³é¢ç‰©é«”</div>
    <button onclick="forceStart()" style="margin-top: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px;">è·³éæƒæç›´æ¥é–‹å§‹</button>
  </div>
  
  <div id="my-error" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(139, 0, 0, 0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; z-index: 1001;">
    <div style="margin-bottom: 20px;">âŒ ARè¼‰å…¥å¤±æ•—</div>
    <div style="font-size: 14px; color: #ffcccb; text-align: center; margin-bottom: 20px;">
      å¯èƒ½åŸå› ï¼š<br>
      â€¢ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•<br>
      â€¢ ç¶²çµ¡é€£ç·šå•é¡Œ<br>
      â€¢ ç€è¦½å™¨ä¸æ”¯æ´WebXR
    </div>
    <button onclick="location.reload()" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; font-size: 16px;">é‡æ–°è¼‰å…¥</button>
    <button onclick="forceStart()" style="margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px;">å¼·åˆ¶é–‹å§‹éŠæˆ²</button>
  </div>

  <script>
    // éŠæˆ²è®Šæ•¸
    let score = 0;
    let missed = 0;
    let gameActive = false;
    let gameInterval;
    let markerFound = false;
    
    // DOMå…ƒç´ 
    const fruitContainer = document.getElementById("fruitContainer");
    const scoreEl = document.getElementById("score");
    const missedEl = document.getElementById("missed");
    const gameStatusEl = document.getElementById("gameStatus");
    const statusTextEl = document.getElementById("statusText");
    const restartBtn = document.getElementById("restartBtn");
    
    // æ°´æœé¡å‹é…ç½®
    const fruitTypes = [
      { 
        name: "apple", 
        mixin: "apple-mixin",
        geometry: "primitive: sphere; radius: 0.1",
        material: "color: #FF6B6B; roughness: 0.2; metalness: 0.1; emissive: #330000",
        scale: "1 1 1"
      },
      { 
        name: "banana", 
        mixin: "banana-mixin",
        geometry: "primitive: cylinder; radius: 0.05; height: 0.15",
        material: "color: #FFE66D; roughness: 0.2; metalness: 0.1; emissive: #332200",
        scale: "1 1 1"
      },
      { 
        name: "grape", 
        mixin: "grape-mixin",
        geometry: "primitive: sphere; radius: 0.08",
        material: "color: #A8E6CF; roughness: 0.2; metalness: 0.1; emissive: #003300",
        scale: "1 1 1"
      },
      { 
        name: "orange", 
        mixin: "orange-mixin",
        geometry: "primitive: sphere; radius: 0.09",
        material: "color: #FF8E53; roughness: 0.3; metalness: 0.1; emissive: #331100",
        scale: "1 1 1"
      },
      { 
        name: "plum", 
        mixin: "plum-mixin",
        geometry: "primitive: sphere; radius: 0.07",
        material: "color: #C7CEEA; roughness: 0.2; metalness: 0.1; emissive: #110033",
        scale: "1 1 1"
      }
    ];

    // å¼·åˆ¶é–‹å§‹éŠæˆ²ï¼ˆè·³éARæƒæï¼‰
    function forceStart() {
      // éš±è—æ‰€æœ‰UIæç¤º
      document.getElementById('my-loading').style.display = 'none';
      document.getElementById('my-scanning').style.display = 'none';
      document.getElementById('my-error').style.display = 'none';
      
      // æ¨¡æ“¬æ¨™è¨˜æ‰¾åˆ°
      markerFound = true;
      
      // é¡¯ç¤ºéŠæˆ²å ´åœ°ï¼ˆå³ä½¿æ²’æœ‰ARæ¨™è¨˜ï¼‰
      const gameMarker = document.getElementById('gameMarker');
      if (gameMarker) {
        gameMarker.setAttribute('visible', true);
        gameMarker.setAttribute('position', '0 0 -2'); // æ”¾åœ¨ç›¸æ©Ÿå‰æ–¹2ç±³
      }
      
      // é–‹å§‹éŠæˆ²
      if (!gameActive) {
        startGame();
      }
    }

    // ç­‰å¾…å ´æ™¯è¼‰å…¥
    document.querySelector('a-scene').addEventListener('loaded', () => {
      console.log('A-Frameå ´æ™¯å·²è¼‰å…¥');
      setupAREvents();
      
      // å¦‚æœ5ç§’å¾Œé‚„æ²’è¼‰å…¥æˆåŠŸï¼Œæä¾›å‚™ç”¨é¸é …
      setTimeout(() => {
        const loadingEl = document.getElementById('my-loading');
        const scanningEl = document.getElementById('my-scanning');
        if (loadingEl && loadingEl.style.display !== 'none') {
          loadingEl.style.display = 'none';
          scanningEl.style.display = 'block';
        }
      }, 5000);
    });

    // è¨­å®šARäº‹ä»¶ç›£è½
    function setupAREvents() {
      const marker = document.getElementById('gameMarker');
      
      // æ¨™è¨˜è¢«æ‰¾åˆ°æ™‚
      marker.addEventListener('targetFound', () => {
        console.log('ARæ¨™è¨˜å·²æ‰¾åˆ°');
        markerFound = true;
        if (!gameActive) {
          startGame();
        }
      });
      
      // æ¨™è¨˜ä¸Ÿå¤±æ™‚
      marker.addEventListener('targetLost', () => {
        console.log('ARæ¨™è¨˜ä¸Ÿå¤±');
        markerFound = false;
        pauseGame();
      });
    }

    // é–‹å§‹éŠæˆ²
    function startGame() {
      console.log('éŠæˆ²é–‹å§‹');
      gameActive = true;
      gameStatusEl.style.display = 'none';
      
      // æ¯1.5ç§’ç”Ÿæˆä¸€å€‹æ°´æœ
      gameInterval = setInterval(() => {
        if (gameActive && markerFound) {
          spawnFruit();
        }
      }, 1500);
    }

    // æš«åœéŠæˆ²
    function pauseGame() {
      if (gameInterval) {
        clearInterval(gameInterval);
      }
      
      if (gameActive) {
        gameStatusEl.style.display = 'block';
        statusTextEl.textContent = 'è«‹é‡æ–°æƒææ¨™è¨˜ç¹¼çºŒéŠæˆ²';
      }
    }

    // é‡æ–°é–‹å§‹éŠæˆ²
    function restartGame() {
      score = 0;
      missed = 0;
      gameActive = false;
      markerFound = false;
      
      scoreEl.textContent = score;
      missedEl.textContent = missed;
      
      // æ¸…é™¤æ‰€æœ‰æ°´æœ
      while (fruitContainer.firstChild) {
        fruitContainer.removeChild(fruitContainer.firstChild);
      }
      
      if (gameInterval) {
        clearInterval(gameInterval);
      }
      
      gameStatusEl.style.display = 'block';
      statusTextEl.textContent = 'è«‹æƒææ¨™è¨˜é–‹å§‹éŠæˆ²';
      restartBtn.style.display = 'none';
    }

    // ç”Ÿæˆæ°´æœ
    function spawnFruit() {
      const fruitType = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
      
      // å‰µå»ºæ°´æœå¯¦é«”
      const fruit = document.createElement("a-entity");
      
      // è¨­å®šå¹¾ä½•é«”å’Œæè³ªï¼ˆä½¿ç”¨mixinæˆ–ç›´æ¥è¨­å®šï¼‰
      if (fruitType.mixin) {
        fruit.setAttribute("mixin", fruitType.mixin);
      } else {
        fruit.setAttribute("geometry", fruitType.geometry);
        fruit.setAttribute("material", fruitType.material);
      }
      
      fruit.setAttribute("scale", fruitType.scale);
      
      // éš¨æ©Ÿä½ç½®ï¼ˆåœ¨æ¨™è¨˜å¹³é¢å…§ï¼‰
      const x = (Math.random() - 0.5) * 1.2;
      const z = (Math.random() - 0.5) * 1.2;
      const startY = -0.3;
      const endY = 1.5;
      
      fruit.setAttribute("position", `${x} ${startY} ${z}`);
      
      // æ·»åŠ ä¸Šå‡å‹•ç•«
      fruit.setAttribute("animation", {
        property: "position",
        to: `${x} ${endY} ${z}`,
        dur: 3000,
        easing: "easeOutQuad"
      });
      
      // æ·»åŠ æ—‹è½‰å‹•ç•«
      fruit.setAttribute("animation__rotate", {
        property: "rotation",
        to: "0 360 0",
        dur: 2000,
        loop: true
      });
      
      // æ·»åŠ æ‡¸æµ®æ•ˆæœ
      fruit.setAttribute("animation__float", {
        property: "position",
        from: `${x} ${startY} ${z}`,
        to: `${x} ${startY + 0.05} ${z}`,
        dur: 1000,
        direction: "alternate",
        loop: true,
        easing: "easeInOutSine"
      });
      
      // è¨­å®šé»æ“Šäº‹ä»¶
      fruit.setAttribute("class", "clickable");
      fruit.setAttribute("cursor", "rayOrigin: mouse");
      
      fruit.addEventListener("click", (event) => {
        event.stopPropagation();
        if (fruit.parentNode && gameActive) {
          // åˆ‡æ°´æœæ•ˆæœ
          sliceFruit(fruit);
          score += 10;
          scoreEl.textContent = score;
        }
      });
      
      // è¨­å®šæ°´æœè‡ªå‹•æ¶ˆå¤±
      const fruitTimeout = setTimeout(() => {
        if (fruit.parentNode && gameActive) {
          fruitContainer.removeChild(fruit);
          missed += 1;
          missedEl.textContent = missed;
          
          // æª¢æŸ¥éŠæˆ²çµæŸæ¢ä»¶
          if (missed >= 5) {
            endGame();
          }
        }
      }, 3000);
      
      // å°‡æ°´æœæ·»åŠ åˆ°å®¹å™¨
      fruitContainer.appendChild(fruit);
      
      console.log(`ç”Ÿæˆäº† ${fruitType.name} æ°´æœ`);
    }

    // åˆ‡æ°´æœæ•ˆæœ
    function sliceFruit(fruit) {
      const currentPos = fruit.getAttribute('position');
      const currentGeometry = fruit.getAttribute('geometry');
      const currentMaterial = fruit.getAttribute('material');
      
      // å‰µå»ºå…©å€‹åˆ‡ç‰‡
      const slice1 = document.createElement('a-entity');
      const slice2 = document.createElement('a-entity');
      
      // è¤‡è£½åŸå§‹æ°´æœçš„å±¬æ€§
      slice1.setAttribute('geometry', currentGeometry);
      slice1.setAttribute('material', currentMaterial);
      slice1.setAttribute('scale', '0.7 0.7 0.7');
      
      slice2.setAttribute('geometry', currentGeometry);
      slice2.setAttribute('material', currentMaterial);
      slice2.setAttribute('scale', '0.7 0.7 0.7');
      
      // è¨­å®šåˆ‡ç‰‡ä½ç½®
      slice1.setAttribute('position', `${currentPos.x - 0.1} ${currentPos.y} ${currentPos.z}`);
      slice2.setAttribute('position', `${currentPos.x + 0.1} ${currentPos.y} ${currentPos.z}`);
      
      // ç§»é™¤åŸå§‹æ°´æœ
      if (fruit.parentNode) {
        fruitContainer.removeChild(fruit);
      }
      
      // æ·»åŠ åˆ‡ç‰‡åˆ°å ´æ™¯
      fruitContainer.appendChild(slice1);
      fruitContainer.appendChild(slice2);
      
      // åˆ‡ç‰‡å‹•ç•«æ•ˆæœ
      slice1.setAttribute('animation', {
        property: 'position',
        to: `${currentPos.x - 0.3} ${currentPos.y - 0.2} ${currentPos.z}`,
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      slice1.setAttribute('animation__fade', {
        property: 'material.opacity',
        to: '0',
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      slice1.setAttribute('animation__rotate', {
        property: 'rotation',
        to: '-45 0 -90',
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      slice2.setAttribute('animation', {
        property: 'position',
        to: `${currentPos.x + 0.3} ${currentPos.y - 0.2} ${currentPos.z}`,
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      slice2.setAttribute('animation__fade', {
        property: 'material.opacity',
        to: '0',
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      slice2.setAttribute('animation__rotate', {
        property: 'rotation',
        to: '45 0 90',
        dur: 800,
        easing: 'easeOutQuad'
      });
      
      // 800mså¾Œæ¸…é™¤åˆ‡ç‰‡
      setTimeout(() => {
        if (slice1.parentNode) fruitContainer.removeChild(slice1);
        if (slice2.parentNode) fruitContainer.removeChild(slice2);
      }, 800);
      
      console.log('æ°´æœè¢«åˆ‡é–‹äº†ï¼');
    }

    // éŠæˆ²çµæŸ
    function endGame() {
      gameActive = false;
      if (gameInterval) {
        clearInterval(gameInterval);
      }
      
      gameStatusEl.style.display = 'block';
      statusTextEl.innerHTML = `éŠæˆ²çµæŸ!<br>æœ€çµ‚å¾—åˆ†: ${score}`;
      restartBtn.style.display = 'inline-block';
      
      // æ¸…é™¤æ‰€æœ‰å‰©é¤˜æ°´æœ
      while (fruitContainer.firstChild) {
        fruitContainer.removeChild(fruitContainer.firstChild);
      }
    }

    // è™•ç†é»æ“Šäº‹ä»¶
    document.addEventListener('click', (event) => {
      if (!gameActive) return;
      
      // æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°æ°´æœ
      const scene = document.querySelector('a-scene');
      const camera = document.querySelector('a-camera');
      
      if (scene && camera) {
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera.getObject3D('camera'));
        
        const fruits = fruitContainer.querySelectorAll('a-entity');
        fruits.forEach(fruit => {
          const object3D = fruit.getObject3D('mesh');
          if (object3D) {
            const intersects = raycaster.intersectObject(object3D);
            if (intersects.length > 0) {
              fruit.click();
            }
          }
        });
      }
    });
  </script>
</body>
</html>
